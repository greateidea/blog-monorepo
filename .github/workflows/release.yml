name: Release

on:
  push:
    branches: [ main ]
  # æ·»åŠ  pull_request äº‹ä»¶ï¼Œç”¨äºæ£€æµ‹ PR åˆå¹¶
  pull_request:
    types: [closed]

      # 2. æ‰‹åŠ¨è§¦å‘ï¼šéšæ—¶æ‰‹åŠ¨éƒ¨ç½²
  workflow_dispatch:
    inputs:
      target_env:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        type: choice
        options: [staging, production]
        default: production
      
      source_type:
        description: 'ä»£ç æ¥æºç±»å‹'
        type: choice
        options:
          - branch:main     # ä¸»åˆ†æ”¯æœ€æ–°
          - branch:release  # æœ€æ–°å‘å¸ƒåˆ†æ”¯
          - tag             # ç‰¹å®šç‰ˆæœ¬æ ‡ç­¾
        default: 'branch:main'
      
      specific_ref:
        description: 'å…·ä½“å¼•ç”¨ï¼ˆé€‰tagæ—¶å¿…é¡»å¡«å†™ï¼‰'
        required: false
        type: string
        default: ''

      # å…³é”®ï¼šæ£€æŸ¥çº§åˆ«é€‰æ‹©
      validation_level:
        description: 'è´¨é‡æ£€æŸ¥çº§åˆ«'
        type: choice
        options:
          - full     # å®Œæ•´æ£€æŸ¥ï¼ˆlint + test + buildï¼‰
          - fast     # å¿«é€Ÿæ£€æŸ¥ï¼ˆä»… build + åŸºæœ¬éªŒè¯ï¼‰
          - skip     # è·³è¿‡æ£€æŸ¥ï¼ˆä»…ç´§æ€¥æƒ…å†µä½¿ç”¨ï¼‰
        default: 'full'

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  # Job 1: åˆ›å»º release PRï¼ˆåªåœ¨ push åˆ° main æ—¶è¿è¡Œï¼‰
  release:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Create Release PR
        uses: changesets/action@v1
        with:
          # å¯¹äº private åŒ…ï¼Œè®¾ç½®ä¸€ä¸ªç©ºæ“ä½œ
          publish: echo "Private packages, skipping publish"
          # å¯é€‰ï¼šæ·»åŠ æ ‡é¢˜æ ‡è¯†ï¼Œæ–¹ä¾¿åç»­è¯†åˆ«
          title: "chore: version updates"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 2: æ£€æµ‹å¹¶å¤„ç†åˆå¹¶çš„ PRï¼ˆåªåœ¨ PR closed æ—¶è¿è¡Œï¼‰
  detect-merged-changeset-pr:
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.user.login, 'github-actions')
    runs-on: ubuntu-latest
    outputs:
      is_changeset_pr: ${{ steps.check-pr.outputs.is_changeset_pr }}
    
    steps:
      - name: Check if PR is from changesets
        id: check-pr
        run: |
          # ç®€å•æ£€æŸ¥ï¼šå¦‚æœæ˜¯ github-actions[bot] åˆ›å»ºçš„ PRï¼Œå°±è®¤ä¸ºæ˜¯ changeset PR
          # å¯ä»¥æ·»åŠ æ›´å¤šæ£€æŸ¥ï¼Œæ¯”å¦‚æ£€æŸ¥ PR æ ‡é¢˜
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ "$PR_TITLE" =~ [Rr]elease || "$PR_TITLE" =~ [Vv]ersion || "$PR_TITLE" =~ [Cc]hangeset ]]; then
            echo "is_changeset_pr=true" >> $GITHUB_OUTPUT
            echo "Detected changeset PR by title pattern"
          else
            # é»˜è®¤ï¼šåªè¦æ˜¯ github-actions[bot] åˆ›å»ºçš„åˆå¹¶ PRï¼Œå°±è®¤ä¸ºæ˜¯ changeset PR
            echo "is_changeset_pr=true" >> $GITHUB_OUTPUT
            echo "Assuming changeset PR by author"
          fi

  # Job 3: éƒ¨ç½²ï¼ˆåªåœ¨åˆå¹¶ changeset PR åè¿è¡Œï¼‰ || æ‰‹åŠ¨è§¦å‘
  deploy:
    name: Deploy to Cloudflare Pages
    needs: detect-merged-changeset-pr
    if: ${{ needs.detect-merged-changeset-pr.outputs.is_changeset_pr == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_env || 'production' }}
      url: https://blog.hiou.top 
    
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    
    steps:
      - name: Determine checkout reference
        id: determine-ref
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©ç¡®å®šref
            case "${{ github.event.inputs.source_type }}" in
              "branch:main")
                echo "ref=main" >> $GITHUB_OUTPUT
                ;;
              "branch:release")
                # æŸ¥æ‰¾æœ€æ–°çš„ release/* åˆ†æ”¯
                LATEST_RELEASE=$(git ls-remote --heads origin "release/*" | tail -1 | cut -f2)
                if [ -z "$LATEST_RELEASE" ]; then
                  echo "æ‰¾ä¸åˆ° release åˆ†æ”¯ï¼Œä½¿ç”¨ main"
                  echo "ref=main" >> $GITHUB_OUTPUT
                else
                  echo "ref=${LATEST_RELEASE#refs/heads/}" >> $GITHUB_OUTPUT
                fi
                ;;
              "tag")
                # ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„æ ‡ç­¾
                if [ -n "${{ github.event.inputs.specific_ref }}" ]; then
                  echo "ref=${{ github.event.inputs.specific_ref }}" >> $GITHUB_OUTPUT
                else
                  echo "è¯·æŒ‡å®šæ ‡ç­¾åç§°ï¼"
                  exit 1
                fi
                ;;
            esac
          else
            # è‡ªåŠ¨è§¦å‘ï¼šä½¿ç”¨å½“å‰è§¦å‘æ¨é€çš„åˆ†æ”¯ï¼ˆmainï¼‰
            echo "ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.determine-ref.outputs.ref }}
          fetch-depth: 0
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install Wrangler
        run: pnpm add -D -w wrangler@3.90.0 

      # æ¡ä»¶æ‰§è¡Œï¼šLint æ£€æŸ¥
      - name: Run Lint
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.validation_level != 'skip' }}
        run: pnpm -w run lint

      # æ¡ä»¶æ‰§è¡Œï¼šæµ‹è¯•ï¼ˆæ ¹æ®çº§åˆ«å†³å®šè¯¦ç»†ç¨‹åº¦ï¼‰
      - name: Run Tests
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.validation_level != 'skip' }}
        run: |
          if [ "${{ github.event.inputs.validation_level }}" = "full" ]; then
            echo "ğŸ” è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶"
            pnpm -w run test:changed
          else
            echo "âš¡ è¿è¡Œå¿«é€Ÿå†’çƒŸæµ‹è¯•..."
          fi

      # æ¡ä»¶æ‰§è¡Œï¼šç±»å‹æ£€æŸ¥
      - name: Type Check
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.validation_level == 'full' }}
        run: pnpm -w turbo run check-types
      
      - name: Generate Auto Version Tag
        id: generate_version
        run: |
          # è·å–å½“å‰å¹´ä»½å’Œå‘¨æ•°
          YEAR_WEEK=$(date -u +%G.%V)
          # è·å–æœ¬å‘¨å†…çš„æäº¤æ¬¡æ•°ï¼Œä½œä¸ºåºåˆ—å·
          COMMIT_COUNT=$(git log --oneline --since="$(date -ud 'monday' +%Y-%m-%d)" | wc -l)
          # è·å–å½“å‰æäº¤çš„çŸ­å“ˆå¸Œ
          COMMIT_SHA_SHORT=$(git rev-parse --short HEAD)
          # ç»„åˆæˆæœ€ç»ˆçš„ç‰ˆæœ¬å·ï¼Œæ ¼å¼å¦‚ 2024.18.5+abc1234
          AUTO_VERSION="$YEAR_WEEK.${COMMIT_COUNT}+${COMMIT_SHA_SHORT}"
          echo "Generated version: $AUTO_VERSION"
          echo "version=$AUTO_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$AUTO_VERSION" >> $GITHUB_ENV

      - name: Create and Push Release Branch (Optional Pointer)
        run: |
          RELEASE_BRANCH="release/${{ steps.generate_version.outputs.version }}"
          echo "Creating and pushing release branch pointer: $RELEASE_BRANCH"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$RELEASE_BRANCH"
          git push origin "$RELEASE_BRANCH"
          echo "âœ… Release branch (mutable pointer) created: $RELEASE_BRANCH"
          git checkout ${{ steps.determine-ref.outputs.ref }}
          echo "âœ… back to ${{ steps.determine-ref.outputs.ref }}"

      - name: Create and Push Git Tag (Immutable Pointer)
        run: |
          TAG_NAME="${{ steps.generate_version.outputs.version }}"
          echo "Creating and pushing immutable tag pointer: $TAG_NAME"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # åˆ›å»ºé™„æ³¨æ ‡ç­¾ï¼ˆAnnotated Tagï¼‰ï¼Œè¿™æ˜¯â€œåªè¯»æŒ‡é’ˆâ€çš„æŠ€æœ¯å®ç°
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "âœ… Git tag (immutable pointer) created and pushed: $TAG_NAME"

      - name: Build Project
        run: |
          echo "ğŸ”§ ä»£ç æ¥æº: ${{ steps.determine-ref.outputs.ref }}"
          echo "ğŸš€ ç›®æ ‡ç¯å¢ƒ: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_env || 'production' }}"
          pnpm -w run build:changed
      
      - name: Publish to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist/ --project-name=hiblog

      - name: Extract Monorepo Changelog for Release
        id: extract_changelog
        env:
          TARGET_VERSION: ${{ steps.generate_version.outputs.version }}
        run: |
          # è¿è¡Œæ–°çš„ Monorepo ç‰ˆè„šæœ¬
          NOTES=$(node .github/scripts/extract-monorepo-changelog.js "$TARGET_VERSION")
          # ä½¿ç”¨å”¯ä¸€åˆ†éš”ç¬¦å®‰å…¨åœ°è®¾ç½®è¾“å‡º
          DELIMITER=$(openssl rand -hex 16)
          echo "notes<<${DELIMITER}" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "${DELIMITER}" >> $GITHUB_OUTPUT
          echo "Release Notes å·²å‡†å¤‡ã€‚"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.generate_version.outputs.version }}
          name: Release ${{ steps.generate_version.outputs.version }}
          body: ${{ steps.extract_changelog.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
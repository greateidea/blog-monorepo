import { getSafeHtmlFromDelta } from "../../utils"

const TestDeltaString = {"ops":[{"insert":"之前的文章里已经对SVELTE的主要设计思想和核心流程做了详细讲解并对主要API做了实现，这次我们直接从svelte在github上的源码进行分析解读，来看看库作者是如何践行设计思想的。\n\n这次我们从svelte的数据结构开始，先了解svelte如何构建一个effect数据结构，再逐步深入了解effect的创建执行流程。因为所有的流程都是基于对数据结构的读写改操作上进行的，只有先了解svelte的数据结构才能知道它在流程中的操作到底是在干什么。\n\n首先你可能会好奇，我们在使用的$effect、$derived时明明是调用的函数呀，怎么这里在说数据结构的事儿呢？是的，没错，$effect、$derived表面上是在执行一个函数，实则只是对数据结构的包装而已。对于svelte这种编译型库来说，要想知道它在运行时做了什么，不要看我们在源文件里写了什么，而是看源文件被编译成什么。\n\n源代码$effect发生什么"},{"attributes":{"header":2},"insert":"\n"},{"insert":"首先我们来看$effect做了什么：\n$effect(() => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    console.log(count)"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"});"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"当我们在源文件里写下这段代码，它最终会被编译成这个样子：\nimport * as $ from 'svelte/internal/client';"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"$.user_effect(() => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    console.log($.get(count));"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"});"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"所以真正创建effect的是一个运行时的调用user_effect，代码精简后，在源码文件effect.js：\nexport function user_effect(fn) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvalidate_effect('$effect');"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    create_user_effect(fn);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"export function create_user_effect(fn) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\treturn create_effect(EFFECT | USER_EFFECT, fn, false);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"它最终是通过一个叫create_effect的函数创建的，那么这个create_effect函数具体又做了什么，代码精简后，源码文件effect.js：\nfunction create_effect(type, fn, sync) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar parent = active_effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tif (parent !== null && (parent.f & INERT) !== 0) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\ttype |= INERT;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar effect = {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tctx: component_context,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tdeps: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tnodes_start: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tnodes_end: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tf: type | DIRTY | CONNECTED,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tfirst: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tfn,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tlast: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tnext: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tparent,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tb: parent && parent.b,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tprev: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tteardown: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\ttransitions: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\twv: 0,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tac: null"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t};"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 递归清除先前关系 执行之前卸载函数 执行注册函数建立双向依赖订阅关系"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tupdate_effect(effect); "},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\teffect.f |= EFFECT_RAN;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar e = effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n\n"},{"insert":"\tif (e !== null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\te.parent = parent;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\tif (parent !== null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tpush_effect(e, parent);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        "},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\treturn effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"可以看见它主要做了几件事：\n"},{"insert":{"listItemContainer":true}},{"insert":"创建一个effect对象"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"调用update_effect先清理所有关系而后重新建立关系"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"调用push_effect将自己加入父effect的子链表"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"\neffect里包含了什么"},{"attributes":{"header":2},"insert":"\n"},{"insert":"我们先来着重讲讲这个effect对象到底包含了哪些主要的属性：\n\n"},{"insert":{"listItemContainer":true}},{"insert":{"blue700-tag":{"id":1765626286068,"text":"deps","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"：这个effect的依赖，也就是那些响应式节点，它们的变化会触发这个effect再次执行\n"},{"insert":{"blue700-tag":{"id":1765626290534,"text":"nodes_start、nodes_end","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"：这个effect关联的dom，我们稍后再详细讲讲这个\n"},{"insert":{"blue700-tag":{"id":1765626292583,"text":"parent","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"：父effect\n"},{"insert":{"blue700-tag":{"id":1765626294517,"text":"next","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"：下一个兄弟effect\n"},{"insert":{"blue700-tag":{"id":1765626296317,"text":"first","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"：子effect链表的第一个\n"},{"insert":{"blue700-tag":{"id":1765626298451,"text":"last","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"：子effect链表的最后一个\n"},{"insert":{"blue700-tag":{"id":1765626300866,"text":"n","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"：你在参数里注册的函数\n\n从这个"},{"attributes":{"bold":true},"insert":"parent、next、first、last"},{"insert":"这几属性可以看出来，"},{"attributes":{"bold":true},"insert":"effect"},{"insert":"实际是一个"},{"attributes":{"bold":true},"insert":"链表"},{"insert":"结构中的一员，每个effect都有"},{"attributes":{"bold":true},"insert":"父、兄、子"},{"insert":"。对于子effect们的记录，为了"},{"attributes":{"bold":true},"insert":"方便链表结构的遍历"},{"insert":"，只记录的子effect链表中的"},{"attributes":{"bold":true},"insert":"第一个和最后一个"},{"insert":"。\n\n加入effect链表"},{"attributes":{"header":2},"insert":"\n"},{"insert":"这样我们就可以来看看是如何将自己加入父effect管理的子effect链表的，源码effect.js：\nfunction push_effect(effect, parent_effect) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar parent_last = parent_effect.last;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tif (parent_last === null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tparent_effect.last = parent_effect.first = effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t} else {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tparent_last.next = effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.prev = parent_last;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tparent_effect.last = effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"标准的链表操作。\n\neffect关联的dom"},{"attributes":{"header":2},"insert":"\n"},{"insert":"接下来讲讲"},{"insert":{"blue700-tag":{"id":1765626407774,"text":"nodes_start、nodes_end","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"这两个属性是怎么回事。之前提到了effect对应的是以整个父兄子的"},{"attributes":{"bold":true},"insert":"链表结构"},{"insert":"，这里我们就可以顺利的灌输一个概念，"},{"attributes":{"bold":true},"insert":"一个effect其实就相当于创建了一个域"},{"insert":"，这个域里又包含了多个子effect也就是多个"},{"attributes":{"bold":true},"insert":"子域"},{"insert":"。每个域都包含自己对应的fn函数、deps依赖项们、关联的dom等等资源。\n\n"},{"attributes":{"bold":true},"insert":"那么这个关联的dom是怎么来的呢？"},{"insert":"\n这里我简略说一下，我们的每个响应式节点最终会被变成一个对应的dom，这个dom就是在一个域中创建的，也就是在执行一个effect时创建的，比如：\n<script>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tlet count = $state(0);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"</script>"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"<p>h1 second child p text {count}</p>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"这里在一个标签里有一个字符串，这个字符串访问了我们创建的响应式节点count，那么这个字符串最终会被编译成这样：\n$.template_effect(() => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t$.set_text(text_1, `h1 second child p text ${$.get(count) ?? ''}`);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"});"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"这里就用template_effect创建了一个域，当调用set_text后就会把这段字符串创建成一个文本节点插入到文档中，此时这个文本节点的dom就会被记录在template_effect创建的effect中，也就是nodes_start、nodes_end中。\n\n如果这个域中有多个dom，那每个dom也由链表来记录，这就等于每个域都有自己关联的dom链表了。\n\n和effect一样，为了方便dom链表的遍历，也只记录了dom链表的第一个和最后一个。这就是nodes_start、nodes_end的由来。\n\nupdate_effect做了什么"},{"attributes":{"header":2},"insert":"\n"},{"insert":"这是"},{"attributes":{"bold":true},"insert":"create_effect"},{"insert":"创建一个effect时，做的第二件事，我给你详细讲讲发生了什么，源代码的runtime.js：\nexport function update_effect(effect) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tset_signal_status(effect, CLEAN); // 设置effect状态"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 切换上下文"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar previous_effect = active_effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar was_updating_effect = is_updating_effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tactive_effect = effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tis_updating_effect = true;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\ttry {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        // 清理 关联dom  依赖订阅关系"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        // 将当前effect从叉树中拆除 并重新连接兄弟父节点的连接"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tif ((flags & (BLOCK_EFFECT | MANAGED_EFFECT)) !== 0) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tdestroy_block_effect_children(effect);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t} else {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tdestroy_effect_children(effect);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\texecute_effect_teardown(effect); // 执行上次执行后返回的teardown"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar teardown = update_reaction(effect); // 在这里执行注册函数建立依赖订阅关系"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.teardown = typeof teardown === 'function' ? teardown : null;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.wv = write_version;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t} finally {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tis_updating_effect = was_updating_effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tactive_effect = previous_effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"来看看它做了几个事情：\n通过 var previous_effect = active_effect 记录先前的active_effect值，并将自己设置为当前的active_effect，并最终在所有工作完成后，将先前的active_effect值恢复：active_effect = previous_effect。稍后我们详细讲这个active_effect是什么;"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"尝试先把自己扒干净，执行清理先前关系和dom等清理工作;"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"上次effect执行后返回了一个卸载函数，也就是我们在$effect注册的函数返回的函数，我们在执行此次effect前先执行这个函数"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"执行此次的effect，也就是我们在$effect的参数里注册的函数，它的执行会重新建立双向依赖订阅关系。"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"\n记录父子effect关系"},{"attributes":{"header":2},"insert":"\n"},{"insert":"那么现在来讲讲你着急想知道的"},{"insert":{"blue700-tag":{"id":1765626612888,"text":"active_effect","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"是什么。之前讲过effect实际是由链表结构记录的，比如在执行一个effect时，在执行的过程中又创建了一个effect，那么它们就应该形成一个父子关系，那当我们创建一个effect的时候，我们怎么知道当前有没有一个"},{"attributes":{"bold":true},"insert":"父effect"},{"insert":"存在呢？\n\n还记得上面的"},{"attributes":{"bold":true},"insert":"create_effect"},{"insert":"函数内，顶部有这样一句代码么：\nfunction create_effect(type, fn, sync) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar parent = active_effect;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"就是由这个"},{"insert":{"blue700-tag":{"id":1765626669350,"text":"active_effect","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"串联起了这个"},{"attributes":{"bold":true},"insert":"父子关系"},{"insert":"。每当创建一个effect时，如果存在一个"},{"insert":{"blue700-tag":{"id":1765626681282,"text":"active_effect","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"那么它就是当前的父级effect并把它记录下来，当effect开始执行时，就把这个变量替换成自己，如果执行过程中又创建了子effect，那么子effect依然用同样的逻辑可以判断它有一个当前的父effect，如此就串联起了父子effect链表结构。\n"},{"insert":{"listItemContainer":true}},{"insert":"\n到此已经彻底讲清楚"},{"attributes":{"bold":true},"insert":"effect"},{"insert":"的真面目其实一个"},{"attributes":{"bold":true},"insert":"链表结构"},{"insert":"，之所以花了很大篇幅来讲清楚这个事情并且给出了域这个概念，就是为了接下来的“"},{"attributes":{"bold":true},"insert":"先把自己扒干净，执行清理先前关系和dom等清理工作"},{"insert":"”，乃至之后的文章中提到的"},{"attributes":{"bold":true},"insert":"销毁流程"},{"insert":"做好铺垫，把这里基础打好了，剩下的内容就可以势如破竹了！\n\n如何把自己扒干净"},{"attributes":{"header":2},"insert":"\n"},{"insert":"这项工作从 "},{"insert":{"blue700-tag":{"id":1765626712014,"text":"destroy_block_effect_children","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":" 或 "},{"insert":{"blue700-tag":{"id":1765626715147,"text":"destroy_effect_children","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":" 开始，无论是哪一个都是先拿出自己的第一个子effect也就是属性里的"},{"insert":{"blue700-tag":{"id":1765626719015,"text":"first","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"，然后调用 "},{"insert":{"blue700-tag":{"id":1765626720928,"text":"destroy_effect","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":" 开始清理工作:\n\n"},{"attributes":{"bold":true},"insert":"destroy_effect -> destroy_effect_children -> destroy_effect -> ..."},{"insert":"\n\n的"},{"attributes":{"bold":true},"insert":"递归流程"},{"insert":"，所以"},{"attributes":{"bold":true},"insert":"整个清理（effect销毁）"},{"insert":"流程其实是从"},{"insert":{"blue700-tag":{"id":1765626787489,"text":"destroy_effect","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"开始的，源码effect.js：\nexport function destroy_effect(effect, remove_dom = true) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar removed = false;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tif ("},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t(remove_dom || (effect.f & HEAD_EFFECT) !== 0) &&"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.nodes_start !== null &&"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.nodes_end !== null"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tremove_effect_dom(effect.nodes_start, /** @type {TemplateNode} */ (effect.nodes_end));"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tremoved = true;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tdestroy_effect_children(effect, remove_dom && !removed); // 递归删除关联dom"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tremove_reactions(effect, 0); // 从每个依赖的订阅者列表中删除自身"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tset_signal_status(effect, DESTROYED); // 设置effect状态"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\texecute_effect_teardown(effect);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar parent = effect.parent;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t// If the parent doesn't have any children, then skip this work altogether"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tif (parent !== null && parent.first !== null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tunlink_effect(effect); // 将当前effect从链表中拆除 并重新连接兄弟父节点的连接"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t// `first` and `child` are nulled out in destroy_effect_children"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t// we don't null out `parent` so that error propagation can work correctly"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\teffect.next ="},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.prev ="},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.teardown ="},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.ctx ="},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.deps ="},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.fn ="},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.nodes_start ="},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.nodes_end ="},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\teffect.ac ="},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tnull;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"来看看这个清理工作做了什么：\n删除关联dom：remove_effect_dom，从记录dom的链表头到链表尾逐个清理"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"然后，在继续其它清理工作之前，先递归让子effect也先清理dom，因为剩下的工作涉及到处理父子链表关系了，要在这之前先清理关联的dom"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"清理依赖订阅关系：remove_reactions，将自己从每个依赖项的订阅者列表里移除，然后清空自己的依赖列表"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"如果有上次effect执行后留下的卸载函数就把它执行掉：execute_effect_teardown"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"处理父子effect链表关系：unlink_effect，将自己从父effect中记录子effect的链表中摘除"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"\n这里的清理工作操作起来，总结就是递归加链表操作，然后再加上一些其它的操作，这就是整个清理effect的流程，这其实就是销毁一个域，就连同销毁这个域下面所有子域的内容。\n\n当然，我们还得注意，对于一个新建的effect实际上是不会执行销毁流程的，在判断的时候就会被过滤掉。\n\n整个创建effect流程包含了"},{"attributes":{"bold":true},"insert":"update_effect流程"},{"insert":"，update_effect流程有包含了"},{"attributes":{"bold":true},"insert":"清理和建立关系"},{"insert":"的过程等等，对于新创建的effect来说，它只用到了“"},{"attributes":{"bold":true},"insert":"建立关系"},{"insert":"”这一流程。\n\n那么为什么还要将整个"},{"attributes":{"bold":true},"insert":"update_effect流程"},{"insert":"放进"},{"attributes":{"bold":true},"insert":"创建effect流程"},{"insert":"里呢，其它步骤岂不是显得多余？\n是的，看起来是显得多余，但是仔细想想，update_effect其实执行的就是："},{"attributes":{"bold":true},"insert":"如何运行一个effect的完整流程"},{"insert":"。从逻辑上来说就是一个完整的闭环了。我们将新建effect执行这个完整流程，只需要经过简单的判断就可以绕开清理流程，对于编码的逻辑性是保持连贯的，对于性能是没有影响的。\n\n重建依赖订阅关系"},{"attributes":{"header":2},"insert":"\n"},{"insert":"源码runtime.js：\n // 建立依赖订阅关系"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"export function update_reaction(reaction) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    var previous_reaction = active_reaction;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar flags = reaction.f;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    "},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tnew_deps = /** @type {null | Value[]} */ (null);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tactive_reaction = (flags & (BRANCH_EFFECT | ROOT_EFFECT)) === 0"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        ? reaction : null;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tupdate_version = ++read_version;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    ...    "},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\ttry {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\treaction.f |= REACTION_IS_UPDATING;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar fn = /** @type {Function} */ (reaction.fn);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar result = fn(); // 执行 get函数：设置new_deps :buildEffect"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar deps = reaction.deps;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\tif (new_deps !== null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tvar i;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"            ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"            // 设置依赖关系"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tif (deps !== null && skipped_deps > 0) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tdeps.length = skipped_deps + new_deps.length;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tfor (i = 0; i < new_deps.length; i++) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tdeps[skipped_deps + i] = new_deps[i];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t} else {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\treaction.deps = deps = new_deps;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tif (is_updating_effect"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                && effect_tracking()"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                && (reaction.f & CONNECTED) !== 0"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            ) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                // 设置订阅关系"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tfor (i = skipped_deps; i < deps.length; i++) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t(deps[i].reactions ??= []).push(reaction);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t} else if (deps !== null && skipped_deps < deps.length) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tremove_reactions(reaction, skipped_deps);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tdeps.length = skipped_deps;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"        ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\treturn result;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t} catch (error) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t} finally {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\treaction.f ^= REACTION_IS_UPDATING;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tactive_reaction = previous_reaction;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"来看看它做了什么：\n记录当前父active_reaction值，将自己设置为当前active_reaction，并在最终执行完所有操作后恢复父active_reaction值：active_reaction = previous_reaction。等等！之前不是有个active_effect么！怎么这里又冒出来一个active_reaction？别着急，我们后面详细说明这是什么，它们之间有什么区别。"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"执行注册的函数，也就是调用$effect时在参数填的函数，获取注册函数返回的卸载函数并在之后返回，这就是effect.teardown的由来"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"执行完注册的函数后，开始构建双向依赖订阅关系"},{"attributes":{"list":"ordered"},"insert":"\n"},{"insert":"\n现在来看看这个"},{"insert":{"blue700-tag":{"id":1765626842667,"text":"active_reaction","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"是什么？\neffect到这里做过两件事情，一是设置自己为"},{"attributes":{"bold":true},"insert":"active_effect"},{"insert":"，二是在这里设置自己为"},{"attributes":{"bold":true},"insert":"active_reaction。"},{"insert":"\n之前提到过effect是由一个父子兄链表关系来记录的，而"},{"attributes":{"bold":true},"insert":"active_effect"},{"insert":"就是用来串联起父子关系的，这就是"},{"attributes":{"bold":true},"insert":"active_effect"},{"insert":"的用途。\n\n而这里我们在做什么？我们正在构建双向"},{"attributes":{"bold":true},"insert":"依赖订阅关系"},{"insert":"，我们来复习一下什么是双向"},{"attributes":{"bold":true},"insert":"依赖订阅关系"},{"insert":"？\neffect的"},{"insert":{"blue700-tag":{"id":1765626858015,"text":"deps","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"属性用来记录所有的依赖，而每个dep有一个"},{"insert":{"blue700-tag":{"id":1765626861467,"text":"reactions","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"属性记录是谁订阅（依赖）了它，一旦这个dep有更新，就会通知所有"},{"attributes":{"bold":true},"insert":"订阅者"},{"insert":"。\n\n所以effect就是这个订阅者的角色。当执行一个effect时，就设置自己为当前"},{"attributes":{"bold":true},"insert":"active_effect，"},{"insert":"在执行过程中，访问到响应式节点会触发节点的"},{"attributes":{"bold":true},"insert":"访问拦截"},{"insert":"，拦截时会检查当前有没有一个"},{"attributes":{"bold":true},"insert":"active_effect，"},{"insert":"如果有这个节点就记录这个"},{"attributes":{"bold":true},"insert":"active_effect"},{"insert":"到自己的reactions内，表示当前这个"},{"attributes":{"bold":true},"insert":"active_effect"},{"insert":"是自己的订阅者之一。\n\n所以，"},{"attributes":{"bold":true},"insert":"active_effect"},{"insert":"就是用来建立订阅者关系的。这就是建立订阅者关系的过程，那又是如何建立依赖关系的呢？\n对于新建effect的流程中，当执行这个effect，并触发内部响应式节点的"},{"attributes":{"bold":true},"insert":"访问拦截"},{"insert":"时，会在全局变量挂一个"},{"attributes":{"bold":true},"insert":"new_deps"},{"insert":"数组，并把当前节点加入到这个"},{"attributes":{"bold":true},"insert":"new_deps"},{"insert":"。当这个effect执行完成时，内部所有访问过的的响应式节点就都存在这个"},{"attributes":{"bold":true},"insert":"new_deps"},{"insert":"中了。\n\nget触发访问拦截，源代码的runtime.js：\nexport function get(signal) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    if (new_deps === null && deps !== null && deps[skipped_deps] === signal) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        skipped_deps++;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    } else if (new_deps === null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        new_deps = [signal];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    } else if (!new_deps.includes(signal)) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        new_deps.push(signal);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    }"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"       "},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    (active_reaction.deps ??= []).push(signal);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    var reactions = signal.reactions;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    if (reactions === null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        signal.reactions = [active_reaction];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    } else if (!reactions.includes(active_reaction)) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        reactions.push(active_reaction);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    }"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"然后我们就可以把这个new_deps变为当前effect的deps，这就是update_reaction源码中对new_deps数组一通操作所干的事儿，这样就完成了双向依赖订阅的建立。但是这只是新建一个effect时新建双向依赖订阅关系的做法，当响应式节点更新并且重新建立关系时，做法稍微有不同，但整体思路都是通过active_reaction来建立起这个关系的。\n"},{"insert":{"listItemContainer":true}},{"insert":"\n分开用active_effect｜reaction"},{"attributes":{"header":2},"insert":"\n"},{"insert":"这里还得讲一下，为什么要将建立effect链表关系和双向依赖订阅关系，通过"},{"insert":{"blue700-tag":{"id":1765626965290,"text":"active_effect","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"、"},{"insert":{"blue700-tag":{"id":1765626968822,"text":"active_reaction","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"这两个变量分开呢？\n\n当我们建立effect时看起来使用一个就够了，只需要标志当前正在运行的是哪个effect就行了，两个事儿那不就是一个事儿么？是的，你想的没错。\n\n"},{"attributes":{"bold":true},"insert":"But"},{"insert":"，事情的发展它出现了变化，半路突然杀出了一个叫"},{"attributes":{"bold":true},"insert":"derived"},{"insert":"的东西，它也管自己叫"},{"attributes":{"bold":true},"insert":"响应式节点"},{"insert":"，它可以作为effect的"},{"attributes":{"bold":true},"insert":"依赖"},{"insert":"，要建立与effect的"},{"attributes":{"bold":true},"insert":"依赖订阅关系"},{"insert":"。好啊，没问题，但怪就怪在，它还要作为"},{"attributes":{"bold":true},"insert":"订阅者"},{"insert":"，建立与其他响应式节点的"},{"attributes":{"bold":true},"insert":"依赖订阅关系"},{"insert":"。\n\n没错，突然出现了一个"},{"attributes":{"bold":true},"insert":"既要又要"},{"insert":"的东西derived，它既是"},{"attributes":{"bold":true},"insert":"响应式节点"},{"insert":"，但又有和effect相同的地方，它以可以成为"},{"attributes":{"bold":true},"insert":"订阅者"},{"insert":"，但不同的是，它不建立和effect一样的"},{"attributes":{"bold":true},"insert":"父子链表关系"},{"insert":"。没错derived就是标准的“渣N”，既要又要还不想负责！\n\n如果像我们刚才想的那样只用一个变量来建立effect"},{"attributes":{"bold":true},"insert":"链表关系和双向依赖订阅关系"},{"insert":"，那么这个"},{"attributes":{"bold":true},"insert":"derived"},{"insert":"的出现显然让这两种行为没法统一，那就只能把这"},{"attributes":{"bold":true},"insert":"两个职责分开"},{"insert":"。这样当遇到"},{"attributes":{"bold":true},"insert":"derived"},{"insert":"时，只需要使用"},{"insert":{"blue700-tag":{"id":1765627059253,"text":"active_reaction","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"来建立依赖订阅关系就行了。\n\n额外小知识"},{"attributes":{"header":2},"insert":"\n"},{"insert":"在以上的源代码中你一定看到了一些奇怪的操作比如：\neffect.f & HEAD_EFFECT !== 0"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"type |= INERT"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"reaction.f ^= REACTION_IS_UPDATING"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"它们是什么意思？\nHEAD_EFFECT、INERT、REACTION_IS_UPDATING 这些都是二进制值，用来它们来代表某一状态或者类型，然后使用位运算比如：\n“|=”的或运算来增加某一个状态；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"“^=”的异或运算来移除某一个状态；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"“&”与运算来判断是否存在某一状态。"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"\n在源码constants.js：\nexport const HEAD_EFFECT = 1 << 18;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"export const INERT = 1 << 13;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"export const REACTION_IS_UPDATING = 1 << 21;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"这就是它们的本来面目。\n"},{"insert":{"listItemContainer":true}},{"insert":{"listItemContainer":true}},{"insert":{"listItemContainer":true}},{"insert":"\n"},{"insert":{"listItemContainer":true}},{"insert":"“<<”表示位移运算：把二进制往左移动 N 位，右边用 0 填补；\n\n1 的二进制是：0000 0000 0000 000"},{"attributes":{"bold":true},"insert":"1"},{"insert":"，当然不止这几个0，每个环境多少位根据环境而定，这里为了演示方便使用16位。JavaScript 数字（Number）内部不是整型，而是 64 位浮点数（IEEE 754），但位运算时，JS 会把数字转成 32 位有符号整数 再操作；\n\n1 << 11 意思就是左移 11 位：0000 "},{"attributes":{"bold":true},"insert":"1"},{"insert":"000 0000 0000；\n\n假设 type = 0000 "},{"attributes":{"bold":true},"insert":"1"},{"insert":"00"},{"attributes":{"bold":true},"insert":"1"},{"insert":"，INERT = 0000 0010，type "},{"attributes":{"bold":true},"insert":"|= "},{"insert":"INERT 就是 type = 0000 "},{"attributes":{"bold":true},"insert":"1"},{"insert":"0"},{"attributes":{"bold":true},"insert":"11"},{"insert":"\n\n此时我们 type & INERT 则会得到一个值 0010，只要&某一个值的结果不等与0，就可以判断得出被&运算的值包含&的值，也就是type & INERT !== 0 则 type 包含 "},{"attributes":{"bold":true},"insert":"INERT"},{"insert":" 这个状态，当然type还可以包含很多其它状态，只要位数还够用。\n\n假设经过以上运算以后，此时 type 已经包含了 "},{"attributes":{"bold":true},"insert":"INERT"},{"insert":" 即 type = 0000 "},{"attributes":{"bold":true},"insert":"1"},{"insert":"0"},{"attributes":{"bold":true},"insert":"11"},{"insert":"，此时：\ntype "},{"attributes":{"bold":true},"insert":"^= INERT"},{"insert":"，等价于 type = type "},{"attributes":{"bold":true},"insert":"^ INERT"},{"insert":";\n运算过程是同位置值相同则取0，值不同值取1，这样同位置都为1的值都会被抵消成0;\n此时 type = 0000 "},{"attributes":{"bold":true},"insert":"1"},{"insert":"00"},{"attributes":{"bold":true},"insert":"1"},{"insert":"，我们就从type中移除了"},{"attributes":{"bold":true},"insert":"INERT"},{"insert":"这一状态;\n\n这就是react和svelte使用的状态操作和判断操作，通过二进制运算，来向一个变量增加或移除状态，然后通过&运算的结果来判断这个变量是否包含某一状态。\n\n最后"},{"attributes":{"header":2},"insert":"\n"},{"insert":"这是一篇非常硬核的文章，直接把svelte在gitHub上的官方源码拉出来详细分析，向你展示了官方是如何创建effect和践行设计思想的。下一篇文章将更加硬核，还是把官方源码拉出来，分析作者是如何实现渲染数组的，它的流程将更加复杂，其中最精彩的便是diff算法的实现，它现在是一个边构建"},{"attributes":{"italic":true,"bold":true},"insert":"LIS（Longest Increasing Subsequence，最长递增子序列）"},{"insert":"边增删移的算法，如果你读完并理解这篇文章的内容，那么下一篇的内容你会势如破竹！\n\n\n\n\n\n"},{"insert":{"listItemContainer":true}},{"insert":"\n\n"},{"insert":{"listItemContainer":true}},{"insert":{"listItemContainer":true}}]}

const safeHtml = getSafeHtmlFromDelta(TestDeltaString)

const result = {
    content: safeHtml,
}

export default result;

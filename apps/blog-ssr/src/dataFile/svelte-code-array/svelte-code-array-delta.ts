import { getSafeHtmlFromDelta } from "../../utils"

const TestDeltaString = {"ops":[{"insert":"之前的文章里详细解读了effect如何创建的，包含了数据结构、清理、更新、构建依赖订阅关系等步骤。这次我们深度分析分析数组在svelte里是如何渲染的，这需要了解一些"},{"attributes":{"link":"https://blog.hiou.top/svelte-code-effect"},"insert":"上一篇文章"},{"insert":"提到的内容。 ​\n\n源文件的数组被编译成什么"},{"attributes":{"header":2},"insert":"\n"},{"insert":"先来看看源文件写一个数组：\n<script>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tlet things = $state(["},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 1, name: 'apple' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 2, name: 'banana', active: true },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 3, name: 'carrot' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 4, name: 'doughnut' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 5, name: 'egg' }"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t]);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"</script>"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"{#each things as item (item.id)}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    <li>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        {item.name}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    </li>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"{/each}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"被编译成什么样子：\nvar root_1 = $.from_html(`<li> </li>`);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"export default function App($$anchor) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tlet things = $.proxy(["},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 1, name: 'apple' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 2, name: 'banana', active: true },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 3, name: 'carrot' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 4, name: 'doughnut' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 5, name: 'egg' }"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t]);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar fragment = $.comment();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar node = $.first_child(fragment);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t$.each(node, 17, () => things, (item) => item.id, ($$anchor, item) => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar li = root_1();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar text = $.child(li, true);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t$.template_effect(() => $.set_text(text, $.get(item).name));"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t$.append($$anchor, li);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t});"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t$.append($$anchor, fragment);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"数组的渲染就交给了一个函数each，它负责渲染的整个过程，那我们来分析each做了什么，源码each.js:\nexport function each(node, flags, get_collection, get_key, render_fn, fallback_fn = null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {Map<any, EachItem>} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar items = new Map();"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {EachItem | null} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar first = null;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar array;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar first_run = true;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tfunction commit() {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\treconcile(state, array, anchor, flags, get_key);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar effect = block(() => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tarray = /** @type {V[]} */ (get(each_array));"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar length = array.length;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar keys = new Set();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar prev = null;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\tfor (var i = 0; i < length; i += 1) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tvar value = array[i];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tvar key = get_key(value, i);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tvar item = first_run ? null : items.get(key);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tif (item) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t// update before reconciliation, to trigger any async updates"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tif (is_reactive_value) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tinternal_set(item.v, value);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\tif (is_reactive_index) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tinternal_set(/** @type {Value<number>} */ (item.i), i);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"                ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t} else {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\titem = create_item("},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tfirst_run ? anchor : null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tprev,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tvalue,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tkey,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\ti,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\trender_fn,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tflags,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tget_collection"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\tif (first_run) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\titem.o = true;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\t\tif (prev === null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t\tfirst = item;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t} else {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t\tprev.next = item;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\t\tprev = item;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\titems.set(key, item);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tkeys.add(key);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"        ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\tif (!first_run) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            commit();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\tget(each_array);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t});"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {EachState} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar state = { effect, flags, items, first };"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tfirst_run = false;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"each主要做的事情就是将渲染的任务放在一个effect域里执行：\n在这个域里，在新建阶段，为每个数组项创建一个专门包裹和记录这一项的数据结构；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"为数组项创建数据结构的同时，也为这一项创建一个域（effect），将每一项的渲染逻辑放在这个域里执行，这个渲染逻辑就是传给each的最后一个参数。"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"每次创建完数据结构就将它存进一个Map里，并将数组项指定的key也专门存放在一个Set里。这两个东西，是为了在数组更新触发整体重新渲染时，留给diff算法用的。"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"\n为什么要在一个域里执行数组渲染\nvar effect = block(() => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tarray = /** @type {V[]} */ (get(each_array));"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"来看看这一句，看似只是调用get获取了当前最新的数组数据，但这里其实做了一件重要的事：get的调用会触发数据的访问拦截，将block创建的域（effect）与each_array建立依赖订阅关系。\n\n这样数组发生变化就会触发这个域（effect）重新执行，然后就会调用diff算法重新渲染数组。\n\n为什么要为每个数组项创建域"},{"attributes":{"header":2},"insert":"\n"},{"insert":"这和在一个域里执行整个数组渲染是一个道理，每个数组项都和自己的域（effect）建立依赖订阅关系，这样每个数组项发生变化就会触发域重新执行，然后单独重新渲染这个数组项\n\n为每个数组项创建数据结构和域\nfor (var i = 0; i < length; i += 1) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    var value = array[i];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    var item = first_run ? null : items.get(key);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    if (item) { ... }"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    else {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        item = create_item("},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            first_run ? anchor : null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            prev,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            value,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            key,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            i,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            render_fn,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            flags,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            get_collection"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        );"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    "},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    }"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"遍历数组，如果是创建阶段，也就是第一次执行（first_run），就用create_item为每个数组项创建数据结构，源码each.js:\nfunction create_item(...) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    var v = ... source(value)) ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    var item = {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\ti,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tv,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tk: key,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\te: null,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\to: false,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tprev,"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tnext: null"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t};"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    item.e = branch(() => render_fn((anchor), v, i, get_collection));"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    return item;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"这里其实对数组项包裹了两次，一次用source包裹是为了get、set操作信息，然后再用item包裹一次是为了链表节点操作和关联effect等，都是对象套对象而已。\n\n重要的是，在包裹的时候，使用branch为该项创建了一个域（effect），并将其挂载这个item的e属性上。\n\n这个域在创建的时候会执行每项的渲染逻辑render_fn，也就是传给each的最后一个参数，执行渲染逻辑的时候是就会建立依赖订阅关系。\n\n这个域（effect）如"},{"attributes":{"link":"https://blog.hiou.top/svelte-code-effect"},"insert":"上一篇文章"},{"insert":"说的那样，是由一个包含父子兄弟关系的链表来记录的，它不仅和域内所有的响应式节点建立依赖订阅关系，还记录了域内所有创建的dom，这样在删除一个数组项的时候，就可以删除对应域和其子域的所有资源，这就是一个域（effect）的销毁过程。\n\n"},{"attributes":{"bold":true},"insert":"源码的diff算法实现"},{"insert":"\n以上我们提到过，整个数组的渲染任务是在一个由"},{"attributes":{"bold":true},"insert":"block"},{"insert":"函数创建的域（effect）里执行的，一旦数组发生变化，那么这个域（effect）就会重新执行，然后重新渲染数组。\n\n重新渲染数组当然不可能重新全部重新渲染一遍，而是更新已经变化的、创建新加的、卸载删除的、移动位置变化的，这就diff算法所做的事情。\n\n直接给你看源代码，你肯定会看的云里雾里，里面的操作繁琐，还是像以前一样，先分析它的设计思路，再看代码如何实践设计思路。\n\n先更新数组项\n在each中block创建的域里面，在新建阶段为每一个数组项"},{"insert":{"blue700-tag":{"id":1765631407549,"text":"create_item","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"创建了对应的数据结构，同时也做了“"},{"attributes":{"bold":true},"insert":"prev.next = item”、“prev = item"},{"insert":"”这些操作，create_item时做了“"},{"attributes":{"bold":true},"insert":"prev.next = item"},{"insert":"”这样的操作，再看看数组项的数据结构包含"},{"attributes":{"bold":true},"insert":"“prev”、“next”"},{"insert":"这样的属性。\n\n那么说明数组项其实是由一个双向链表来记录的，"},{"insert":{"blue700-tag":{"id":1765631419795,"text":"create_item","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"创建的就是一个链表节点，算法的操作都是链表操作。\n\n如之前所讲，每个数组项在创建时都用对应的\"key\"保存在了一个"},{"attributes":{"bold":true},"insert":"Map"},{"insert":"中，每个项既是一个链表节点，也同时被记录在这个Map中，这样就可以通过key直接拿到链表中对应项的数据。\n\n好了，假如现在这个数组发生了变化（删除了项、新增了项、移动了项位置）。\n\n此时block创建的域重新执行，这时已经不是创建阶段了，因为在第一次执行的时候已经为之前每个项创建了数据结构。\n\n首先尝试对所有项进行更新，源码each.js:\nvar effect = block(() => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    array = /** @type {V[]} */ (get(each_array));"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    "},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    for (var i = 0; i < length; i += 1) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"        var value = array[i];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        var key = get_key(value, i);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        var item = first_run ? null : items.get(key);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        if (item) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            // update before reconciliation, to trigger any async updates"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"           \tif (is_reactive_value) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                internal_set(item.v, value);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"            ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    }"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"现在有两组数据，一组是记录旧数组数据的双向链表，一组是现在的新数组，新数组相对旧数组可能发生了删除了项、新增了项、移动了项位置变化，而这里的任务就是：\n旧数组链表每项更新为新数组里对应项的最新值。\n\n以上代码遍历新数组：\n"},{"attributes":{"bold":true},"insert":"var value = array[i]拿到此项最新内容"},{"attributes":{"list":"bullet"},"insert":"\n"},{"attributes":{"bold":true},"insert":"get_key拿到此项的key"},{"insert":"；（"},{"attributes":{"italic":true},"insert":"这个函数的由来就是我们在源文件写的：{#each things as item (item.id)}，这里的 (item.id) 最终在编译时被替换成一个 (item) => item.id 函数，然后传给了each函数在这里被调用）"},{"insert":"。"},{"attributes":{"list":"bullet"},"insert":"\n"},{"attributes":{"bold":true},"insert":"再通过items.get(key)拿到旧数组链表中的项；"},{"insert":"（"},{"attributes":{"italic":true},"insert":"items就是之前反复提到的用来存储每个项的Map"},{"insert":"）。"},{"attributes":{"list":"bullet"},"insert":"\n"},{"attributes":{"bold":true},"insert":"如果在旧数组的链表中还能找到对应的项，就更新它；"},{"insert":"（"},{"attributes":{"italic":true},"insert":"此时也会触发这个数组项对应的域（effect）重新执行，然后重新渲染此项的dom。create_item时会调用branch为此项创建一个域"},{"insert":"）。"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"\n先把数据更新完后，我们就可以开始来调用diff算法来做辗转腾挪了。\n\ndiff算法的目的"},{"attributes":{"header":2},"insert":"\n"},{"insert":"diff算法的目的，将旧数组的链表更新为新数组的链表：\n"},{"attributes":{"bold":true},"insert":"将旧数组链表按照新数组的顺序来排列；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"attributes":{"bold":true},"insert":"销毁旧数组链表中有，但新数组没有的多余项；"},{"insert":"（说明新数组删除了旧数组的项）"},{"attributes":{"list":"bullet"},"insert":"\n"},{"attributes":{"bold":true},"insert":"新建新数组中有，但旧数组没有的项；"},{"insert":"（说明新数组里有新建的项）"},{"attributes":{"list":"bullet"},"insert":"\n"},{"attributes":{"bold":true},"insert":"这样链表就得到了更新，变成了当前新数组对应的链表了。"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"\ndiff算法的设计思路\n任何一个算法，必然是先有理论的设计思路，才有代码的实践。\n\n假设当前的新数组："},{"attributes":{"bold":true},"insert":"a b d e f g h i j k"},{"insert":"\n\n基本思路：\n不管旧链表相比新数组如何混乱，但只要能把新数组的内容，在旧链表里按照相对顺序排列好：\nxxx "},{"attributes":{"bold":true},"insert":"abd"},{"insert":" xx "},{"attributes":{"bold":true},"insert":"efg"},{"insert":" x "},{"attributes":{"bold":true},"insert":"hijk"},{"insert":" xxx\n并且记录下这些\"x\"，最后把这些\"x\"给删掉，链表里的元素不就和新数组里一样了嘛！\n\ndiff算法核心的真相就是如此朴实无华！还是那句话：“"},{"attributes":{"italic":true},"insert":"高端的食材往往只需要最朴素的烹饪方式"},{"insert":"”！\n\ndiff算法的代码实践流程\n那么好，我们来实际演示一下，落实到代码上这个流程再怎么走，怎么形成最终的我们想要的结果。\n\n假设现在有一个旧数组链表和一个新数组：\nA B S C "},{"attributes":{"bold":true},"insert":"DEF"},{"insert":" G H "},{"attributes":{"bold":true},"insert":"IJK"},{"insert":" "},{"attributes":{"bold":true},"insert":"LMN"},{"insert":" O P Q （这是一个双向链表结构）\nDEF IJK B LMN S （这是新数组，为了方便对应，仍使用大写字母）\n\n我们以遍历新数组开始，并将旧数组链表第一个位置标记为current：\n\n"},{"attributes":{"bold":true},"insert":"遍历到D："},{"insert":"\n检查链表current为A，不是D；\n此时，用数组stash变量记录刚才掠过的 A，用名为seen的Set变量记录A；\n\ncurrent指向下一个B，不是D；\n此时，stash记录掠过的 B，seen记录B；\n\ncurrent指向下一个S，不是D；\n此时，stash记录掠过的 S，seen记录S；\n\ncurrent指向下一个C，不是D；\n此时，stash记录掠过的 C，seen记录C；\n\ncurrent指向下一个D，是D，用名为matched数组记录匹配到的D，current指向下一个E；\n此时，stash：A B S C，seen：A B S C； matched：D；\n\n"},{"attributes":{"bold":true},"insert":"遍历到E："},{"insert":"\ncurrent为E，matched记录E，current指向下一个F；\n此时，stash：A B S C，seen：A B S C；matched：DE；\n\n"},{"attributes":{"bold":true},"insert":"遍历到F："},{"insert":" \ncurrent为F，matched记录F，current指向下一个G；\n此时，stash：A B S C，seen：A B S C；matched：DEF；\n\n这里，可以发现一个现象：DEF是一个连续的片段，A B S C是形成DEF这个连续片段之前被掠过的片段，也就是A B C这个片段间隔了DEF这个连续片段；\n\n到此我们可以建立一个概念：在DIFF算法进行时，链表中存在两种片段，一个是"},{"insert":{"blue700-tag":{"id":1765631495061,"text":"连续片段","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"，一个连续片段之间的"},{"insert":{"blue700-tag":{"id":1765631498674,"text":"间隔片段","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"；\n\n｜A B S C｜ "},{"attributes":{"bold":true},"insert":"DEF"},{"insert":"｜ G H ｜"},{"attributes":{"bold":true},"insert":"IJK"},{"insert":" "},{"attributes":{"bold":true},"insert":"LMN"},{"insert":" O P Q\nDEF IJK B LMN S\n\n"},{"attributes":{"bold":true},"insert":"stash"},{"insert":"：记录当前这个连续片段之前的间隔片段，当需要什么操作时就可以找到它；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"attributes":{"bold":true},"insert":"seen"},{"insert":"：记录所有被掠过的内容，新数组后面出现的项可能出现在前面被掠过的内容里面；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"attributes":{"bold":true},"insert":"matched"},{"insert":"：记录此次形成的连续片段；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"\n我们继续向后遍历，继续寻找链表中存在的连续片段。\n"},{"attributes":{"bold":true},"insert":"遍历到 I："},{"insert":"\n如之前一样，此时先清空stash、matched，掠过了G H\nstash开始记录此次寻找连续片段之前的间隔片段：G H；\nmatched开始记录此次会形成的连续片段；\n\n"},{"attributes":{"bold":true},"insert":"遍历到 J和K也一样："},{"insert":"\n没有在再掠过任何内容，又形成了一个连续片段 matched：IJK；\n此时，它之前的间隔片段 stash：G H\nseen：A B S C G H；\n\n"},{"attributes":{"bold":true},"insert":"遍历到B："},{"insert":"\n旧链表：A B S C DEF G H IJK "},{"attributes":{"underline":true,"italic":true},"insert":"L"},{"insert":"MN O P Q\n新数组：DEF IJK B LMN S\n\ncurrent："},{"attributes":{"underline":true,"italic":true},"insert":"L"},{"insert":"，不是B；\n\n发现B存在于过去掠过的内容seen：A B C G H里面；\n这时出现一个问题：根据新数组的顺序，旧链表中的B打破了连续片段的形成；\n此时我们有两个办法：\n1:把B从链表中挪到 "},{"attributes":{"underline":true,"italic":true},"insert":"L "},{"insert":"前面：A S C DEF G H IJK B"},{"attributes":{"underline":true,"italic":true},"insert":"L"},{"insert":"MN O P Q；\n2:交换连续片段和它之前的间隔片段，形成一大片大连续片段：\n旧链表：A "},{"attributes":{"bold":true},"insert":"B"},{"insert":" S C "},{"attributes":{"underline":true,"bold":true},"insert":"DEFIJK"},{"attributes":{"bold":true},"insert":" "},{"attributes":{"underline":true,"italic":true},"insert":"G H"},{"insert":" "},{"attributes":{"underline":true,"italic":true},"insert":"L"},{"insert":"MN O P Q"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"新数组："},{"attributes":{"underline":true,"italic":true,"bold":true},"insert":"DEF"},{"attributes":{"underline":true,"italic":true},"insert":" "},{"attributes":{"underline":true,"italic":true,"bold":true},"insert":"IJK"},{"insert":" "},{"attributes":{"bold":true},"insert":"B"},{"insert":" LMN S"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"\t然后我们再把 "},{"attributes":{"bold":true},"insert":"B"},{"insert":" 挪到 "},{"attributes":{"underline":true,"italic":true},"insert":"L "},{"insert":"前面；\n\n"},{"attributes":{"italic":true},"insert":"交换片段的好处是："},{"attributes":{"italic":true,"bold":true},"insert":"间隔片段"},{"attributes":{"italic":true},"insert":"也是之前掠过的部分，我们把这部分挪到后面，就减少了出现B这种打破形成连续片段的概率，也就提高了继续形成连续片段的概率；"},{"insert":"\n\n那么我们在这里到底要进行哪一种操作呢？\n这就转变成一个"},{"attributes":{"bold":true},"insert":"迁移成本"},{"insert":"的问题了，从"},{"attributes":{"bold":true},"insert":"交换片段"},{"insert":"的角度考虑：\n\n间隔片段：G H，连续片段： IJK。\n\n别忘了，数组的每一项都有自己的域（effect）还有这个域下面所有的"},{"attributes":{"bold":true},"insert":"dom"},{"insert":"，如果进行"},{"attributes":{"bold":true},"insert":"交换片段"},{"insert":"，在链表层面只需要把 IJK挪到G H前面。\n\n但是移动dom的操作使用的是"},{"insert":{"blue700-tag":{"id":1765631516588,"text":"insertBefore","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"，此时的操作就是把 IJK里面的所有的"},{"attributes":{"bold":true},"insert":"dom"},{"insert":"往G H前面插入，我要把3项的内容往两项前面插入，那如果这个连续片段有100项呢，那就要把100项往两项前面插入？这岂不是费大力气干小活？页面性能肯定是负优化！\n\n所以到了B这里，我们要做的是把B挪到"},{"attributes":{"underline":true,"italic":true},"insert":"L"},{"insert":"前面，然后删除seen里的B，清空stash、matched，然后重新开始寻找连续片段：\n\n旧链表：A S C "},{"attributes":{"underline":true},"insert":"DEFIJK"},{"insert":" G H"},{"attributes":{"bold":true},"insert":"B "},{"attributes":{"underline":true,"italic":true},"insert":"L"},{"insert":"M N O P Q R S T\n新数组：DEF IJK "},{"attributes":{"bold":true},"insert":"B"},{"insert":" "},{"attributes":{"underline":true},"insert":"L"},{"insert":"M S\n\nstash：G H\nseen：A S C G H\nmatched：IJK\n\n我们按照同样的逻辑继续，直到遍"},{"attributes":{"bold":true},"insert":"历到"},{"attributes":{"italic":true,"bold":true},"insert":"Q"},{"attributes":{"bold":true},"insert":"："},{"insert":"\n\n旧链表：A "},{"attributes":{"italic":true,"bold":true},"insert":"Q"},{"insert":" C DEF G H IJK B"},{"attributes":{"bold":true},"insert":" "},{"insert":"LM N"},{"attributes":{"italic":true},"insert":" "},{"insert":"O P"},{"attributes":{"italic":true},"insert":" "},{"insert":"S"},{"attributes":{"italic":true},"insert":" "},{"attributes":{"underline":true,"italic":true},"insert":"R"},{"attributes":{"italic":true},"insert":" T"},{"insert":"\n新数组：DEF IJK B LM S"},{"attributes":{"bold":true},"insert":" "},{"attributes":{"italic":true,"bold":true},"insert":"Q"},{"insert":"\n\ncurrent："},{"attributes":{"underline":true,"italic":true},"insert":"R"},{"insert":"\n间隔片段stash：N O P\n连续片段matched："},{"attributes":{"bold":true},"insert":"S"},{"insert":"\nseen：A "},{"attributes":{"italic":true,"bold":true},"insert":"Q "},{"insert":"C G H N O P\n\n此时"},{"attributes":{"bold":true},"insert":"Q"},{"insert":"出现了和之前"},{"attributes":{"bold":true},"insert":"B"},{"insert":"一样的情况，它出现在"},{"attributes":{"bold":true},"insert":"旧链表"},{"insert":"里之前被掠过的部分。\n\n此时是应该交换片段还是直接把"},{"attributes":{"italic":true},"insert":"Q"},{"insert":"插到R前呢？\n我们来看看，连续片段：S 只有一项，间隔片段：N O P 有三项，如果把S挪到Q前面是不是成本相比之前B的操作是不是变低了！\n\n所以结论就是应该"},{"attributes":{"bold":true},"insert":"交换片段"},{"insert":"，然后把"},{"attributes":{"italic":true},"insert":"Q"},{"insert":"插到R前，然后删除seen里的Q，清空stash、matched：\n\n旧链表：A C "},{"attributes":{"underline":true,"bold":true},"insert":"DEF"},{"insert":"  G H  "},{"attributes":{"underline":true,"bold":true},"insert":"IJK"},{"insert":"  "},{"attributes":{"underline":true,"bold":true},"insert":"B"},{"attributes":{"bold":true},"insert":" "},{"insert":" "},{"attributes":{"underline":true,"bold":true},"insert":"LM"},{"attributes":{"italic":true},"insert":" "},{"insert":"N"},{"attributes":{"italic":true},"insert":" "},{"insert":"O P "},{"attributes":{"underline":true,"bold":true},"insert":"S"},{"insert":" "},{"attributes":{"underline":true,"bold":true},"insert":"Q"},{"insert":"  "},{"attributes":{"italic":true},"insert":"R T"},{"insert":"\n新数组：DEF IJK B LM S"},{"attributes":{"bold":true},"insert":" "},{"insert":"Q\n\n间隔片段stash：空\n连续片段matched：空\n\nseen：A C G H N O P\n剩余片段：R"},{"attributes":{"italic":true},"insert":" "},{"insert":"T\n\n至此，遍历结束，我们来看看最终的结果：\n新数组里所有的元素，都在旧链表里按照相对顺序完成排列了，且形成了完整了"},{"insert":{"blue700-tag":{"id":1765631562809,"text":"间隔片段","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"和"},{"insert":{"blue700-tag":{"id":1765631565302,"text":"剩余片段","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"。\n\n这些最终剩下的间隔片段内所有的内容都随着遍历被记录在了seen里面，而剩余片段则只需要继续接着current遍历便可获取；\n\n最后："},{"attributes":{"bold":true},"insert":"间隔片段 + 剩余片段 = 需要删除销毁的内容"},{"insert":"；\n\ndiff算法新增新项"},{"attributes":{"header":2},"insert":"\n"},{"insert":"你可能会说，好像忘了新增的项，因为这个太简单了：遍历到这一项，它要是在旧数组里没有那就是新增的，直接就地"},{"insert":{"blue700-tag":{"id":1765631922883,"text":"create_item","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"创建新项插入链表当前位置，并把域（effect）内关联的dom也插入当前位置对应的dom前面。为了方便主流分析程而没有加进去。\n\n总结一下这个算法的做法，其实很简单：按照新数组的顺序，不断寻找旧链表里的连续片段，如果不能形成连续片段，就是通过交换片段和挪动项的方式构造连续片段，最终剩下需要销毁的间隔片段和剩余片段。\n\n再总结一下：这是一个寻找和建立"},{"attributes":{"bold":true},"insert":"LIS（Longest Increasing Subsequence，最长递增子序列）"},{"insert":"的过程。\n\n剩下的就是如何销毁了剩余内容了，完成这一步，旧链表就变成新链表啦！\n\ndiff算法的优点"},{"attributes":{"header":2},"insert":"\n"},{"insert":"这个算法的优点是通过交换片段和数组项在整体上最大程度减少转移过程中对dom的操作，同时在每次转移中尽可能多但又不过多的转移和操作dom来提升每次转移的性能，进而在整体上提升数组更新渲染的性能。\n\ndiff算法源码"},{"attributes":{"header":2},"insert":"\n"},{"insert":"源码each.js:\nfunction reconcile(state, array, anchor, flags, get_key) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar is_animated = (flags & EACH_IS_ANIMATED) !== 0;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar length = array.length;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar items = state.items;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar current = state.first;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {undefined | Set<EachItem>} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar seen;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {EachItem | null} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar prev = null;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {EachItem[]} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar matched = [];"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {EachItem[]} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar stashed = [];"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {V} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar value;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {any} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar key;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {EachItem | undefined} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar item;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t/** @type {number} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar i;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tfor (i = 0; i < length; i += 1) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvalue = array[i];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tkey = get_key(value, i);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\titem = /** @type {EachItem} */ (items.get(key));"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\tstate.first ??= item;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"        // 新建新增项"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tif (!item.o) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\titem.o = true;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tvar next = prev ? prev.next : current;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tlink(state, prev, item);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tlink(state, item, next);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tmove(item, next, anchor);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tprev = item;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tmatched = [];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tstashed = [];"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tcurrent = prev.next;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tcontinue;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\tif (item !== current) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tif (seen !== undefined && seen.has(item)) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                // matched 是连续片段，stashed 是间隔片段"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                // 我们需要考虑的是 如果连续片段超过了间隔片段 那么交换片段伴随需要移动的dom就过多"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                // 因此 连续片段 过多就挪动 当前item 继续构造当前连续片段"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                // 比如 连续片段有1000个 而间隔片段只有3个 那么把这1000个往这3个前面移动且伴随dom移动迁移 成本就很太高了"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tif (matched.length < stashed.length) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t// more efficient to move later items to the front"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tvar start = stashed[0]; // 掠过列表的首个"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tvar j;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\t\tprev = start.prev; // 掠过列表的首个的前个"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\t\tvar a = matched[0]; // 已匹配列表的首个"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tvar b = matched[matched.length - 1]; // 已匹配列表的末尾"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\t\tfor (j = 0; j < matched.length; j += 1) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                        // move挪动的是对应的effect关联的dom"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t\tmove(matched[j], start, anchor);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\t\tfor (j = 0; j < stashed.length; j += 1) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t\tseen.delete(stashed[j]);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"                    // 链表操作 目标是完成最近连续片段和间隔片段换位"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tlink(state, a.prev, b.next);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tlink(state, prev, a);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tlink(state, b, start);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\t\tcurrent = start;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tprev = b;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\ti -= 1;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\t\tmatched = [];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tstashed = [];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t} else {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\t// more efficient to move earlier items to the back"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tseen.delete(item);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tmove(item, current, anchor);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"                    // 目标是将 当前item 接到 上次连续片段 后"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tlink(state, item.prev, item.next);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tlink(state, item, prev === null ? state.first : prev.next); "},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t\tlink(state, prev, item);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\t\tprev = item;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\t\tcontinue;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tmatched = [];"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tstashed = [];"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\twhile (current !== null && current !== item) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"                ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tstashed.push(current);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tcurrent = current.next;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\tif (current === null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tcontinue;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t\titem = current;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\tmatched.push(item);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tprev = item;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tcurrent = item.next;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 销毁剩余项"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\n销毁剩余的内容"},{"attributes":{"header":2},"insert":"\n"},{"insert":"相比diff算法的复杂度这里就简单的多了。这里我们首先要收集要销毁的内容，它们是最终没有在新数组中出现的内容，这就是最终的"},{"attributes":{"bold":true},"insert":"间隔片段+剩余片段"},{"insert":"，然后销毁它们就行了。\n\n先收集最终的间隔片段"},{"attributes":{"header":2},"insert":"\n"},{"insert":"前面提到过，当遍历结束后，最终所有间隔片段的内容都被记录到"},{"insert":{"blue700-tag":{"id":1765631609401,"text":"seen","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"中，所以可以直接把这个内容放在一个"},{"insert":{"blue700-tag":{"id":1765631612631,"text":"to_destroy","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"数组里作为"},{"attributes":{"bold":true},"insert":"销毁列表"},{"insert":"，源码each.js:\nif (current !== null || seen !== undefined) {"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    var to_destroy = seen === undefined ? [] : array_from(seen);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 收集剩余片段"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 开始销毁"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\n收集剩余片段\n剩余片段就是遍历结束了，在链表结束位置之后未被访问过的内容，说明新数组相比旧数组，已经不再包含这些内容了。我们只需要接着链表当前停下的位置遍历到结束，就可以收集"},{"insert":{"blue700-tag":{"id":1765631624354,"text":"剩余片段","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"的内容了：\nif (current !== null || seen !== undefined) {"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 收集最终的间隔片段"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    while (current !== null) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        if ((current.e.f & INERT) === 0) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            to_destroy.push(current);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        }"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        current = current.next;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    }"},{"attributes":{"code-block":"javascript"},"insert":"\n\n\n"},{"insert":"    // 开始销毁"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\n开始销毁"},{"attributes":{"header":2},"insert":"\n"},{"insert":"销毁流程也不是很难，主要是做了几件事情：\n\n先收集销毁列表中有结束动画的项；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"触发所有销毁动画；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"所有动画结束后立即执行真正的销毁工作；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"\n收集有结束动画的项"},{"attributes":{"header":2},"insert":"\n"},{"insert":"源码each.js:\nfunction pause_effects(state, to_destroy, controlled_anchor) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t/** @type {TransitionManager[]} */"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar transitions = []; // 有结束动画的项"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar length = to_destroy.length;"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 遍历销毁列表 把有结束动画的项 收集到transitions中"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tfor (var i = 0; i < length; i++) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tpause_children(to_destroy[i].e, transitions, true);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 触发transitions中所有的结束动画"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    // 动画结束 立即执行销毁工作"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\trun_out_transitions(transitions, () => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        // 执行销毁操作"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t..."},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t});"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\n触发所有结束动画"},{"attributes":{"header":2},"insert":"\n"},{"insert":"那么这个等待结束动画然后执行清理工作是怎么做的呢？源码effects.js:\nexport function run_out_transitions(transitions, fn) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar remaining = transitions.length;"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tif (remaining > 0) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar check = () => --remaining || fn();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tfor (var transition of transitions) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\ttransition.out(check);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t} else {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tfn();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"通过遍历挨个"},{"insert":{"blue700-tag":{"id":1765631643134,"text":"transition.out","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"触发该项的结束动画，每个动画结束后都是执行回调check，当最后一个动画结束执行回调：--"},{"attributes":{"bold":true},"insert":"remaining || fn()"},{"insert":"，此时"},{"attributes":{"bold":true},"insert":"remaining"},{"insert":"变成0，回调进而执行fn()。而fn()就是我们传入的用来执行清理工作的函数。\n\n执行清理工作"},{"attributes":{"header":2},"insert":"\n"},{"insert":"清理工作分为两种：\n一种是在编译时就被判定为删除整个数组的操作；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"一种是挨个销毁要删除的项；"},{"attributes":{"list":"bullet"},"insert":"\n"},{"insert":"\n源码each.js:\nfunction pause_effects(state, to_destroy, controlled_anchor) {"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 遍历销毁列表 把有结束动画的项 收集到transitions中"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"    // 触发transitions中所有的结束动画"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    // 动画结束 立即执行销毁工作"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\trun_out_transitions(transitions, () => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        // 执行销毁操作"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"        // 执行销毁整个数组的操作"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tif (fast_path) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            ..."},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"            // 直接清空根节点dom"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tclear_text_content(parent_node);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tparent_node.append(anchor);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"            // 直接清空链表"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tstate.items.clear();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tlink(state, to_destroy[0].prev, to_destroy[length - 1].next);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"        // 挨个销毁"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tfor (var i = 0; i < length; i++) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tvar item = to_destroy[i];"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"            // 链表操作"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tif (!fast_path) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tstate.items.delete(item.k);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t\tlink(state, item.prev, item.next);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"            // 执行清理域（effect） 工作"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            // 清理effect及其所有子域（effect）"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            // 每个域需要清理自己的关联dom"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            // 清理域内所有依赖订阅关系"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"            // 断开兄弟父子双向链表连接"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t\tdestroy_effect(item.e, !fast_path);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t});"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"到此清理工作已基本结束，如果还不熟悉destroy_effect，可以继续看看我之前的文章"},{"attributes":{"link":"https://blog.hiou.top/svelte-code-effect"},"insert":"《SVELTE源码分析：如何创建一个effect》"},{"insert":"：里面详细解释了到底什么是effect（域）、如何创建effect（域）、销毁effect（域）、以及它与derived的本质区别。\n\n补充\neffect有一个属性f，它用二进制位运算来保存effect所有的状态，如果：\n(effect.f & INERT) !== 0\n\n则说明effect此时包含"},{"attributes":{"bold":true},"insert":"INERT"},{"insert":"这个状态。"},{"attributes":{"bold":true},"insert":"INERT"},{"insert":"这个状态的含义就是：这是一个已经标记为需要删除的项，它已确定不在最新的渲染列表里，任何渲染操作碰到这个状态都不要执行。\n\n在销毁过程里，如果某个项有结束动画，那么结束动画执行期间这个项仍然是存在的。此时如果这个项对应的依赖发生变化通知这个项该更新渲染了，那岂不是很矛盾，所以这个项此时会有一个"},{"attributes":{"bold":true},"insert":"INTER"},{"insert":"标记，阻止在结束动画执行期间的任何渲染操作。\n\n最后"},{"attributes":{"header":2},"insert":"\n"},{"insert":"这次我们从源码级别系统性、结构化的梳理了svelte的数组的渲染过程，它包含创建、更新、移动、删除、销毁整个完整过程。并在讲解diff算法时，通过先点开算法实际目的和设计思想，开局直接帮你降低50%的难度，再看源码操作落地的过程，帮你解开diff算法的神秘面纱，你最终会觉得，其实也没那么难～能走到这里，我相信你已经有了非常大的收获，又拉开了与别人非常巨大一步的差距，今后我们继续加油！\n\n"}]}

const safeHtml = getSafeHtmlFromDelta(TestDeltaString)

const result = {
    content: safeHtml,
}

export default result;

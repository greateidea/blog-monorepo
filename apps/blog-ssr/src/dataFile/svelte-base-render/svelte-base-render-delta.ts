import { getSafeHtmlFromDelta } from "../../utils"

const TestDeltaString = {"ops":[{"attributes":{"bold":true},"insert":"Svelte"},{"insert":"相比目前常用的"},{"attributes":{"bold":true},"insert":"React、Vue"},{"insert":"等库最大的区别就是不需要虚拟Dom，在更新上也不需要经过"},{"attributes":{"bold":true},"insert":"虚拟Dom"},{"insert":"的对比操作，而是在响应式系统的基础上，直接在Dom层面细粒度的精准操作。相同的地方是Svelte是编译代码配合运行时调用来运行整个应用的。下面我们就从分析编译后生成的代码来分析，"},{"attributes":{"bold":true},"insert":"Svelte"},{"insert":"是如何运行的。\n\n\nSvelte编译产物分析"},{"attributes":{"header":2},"insert":"\n"},{"insert":"我们先准备一份.svelte代码，它由最基本的"},{"attributes":{"bold":true},"insert":"script"},{"insert":"和"},{"attributes":{"bold":true},"insert":"html"},{"insert":"模板组成：\n<script>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tlet count = $state(0);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tlet things = $state(["},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 1, name: 'apple' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 2, name: 'banana' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 3, name: 'carrot' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 4, name: 'doughnut' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 5, name: 'egg' }"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t]);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"</script>"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"<h1>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\th1 first child text {count}!"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t<p>h1 second child p text {count}</p>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\th1 third child text {count}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t<p>h1 forth child p text</p>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"</h1>"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"<button onclick={() => count += 1}>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tclicks: {count}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"</button>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"{#each things as thing (thing.id)}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t<li>{thing.id} x {thing.name}</li>"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"{/each}"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\n在html模板的"},{"attributes":{"bold":true},"insert":"h1、button、列表内分别访问了响应式变量count、things"},{"insert":"。而h1节点内构造了简单的子节点和兄弟节点，其中最后一个“"},{"attributes":{"bold":true},"insert":"<p>h1 forth child p text</p>"},{"insert":"”是一串"},{"attributes":{"bold":true},"insert":"“静态的”“固定的”"},{"insert":"节点，也就是说它没有访问任何变量，诞生后也不会再有任何变化。\n\n编译后的产物：\nimport 'svelte/internal/disclose-version';"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"import 'svelte/internal/flags/async';"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"import * as $ from 'svelte/internal/client';"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"var root_1 = $.from_html(`<li> </li>`);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"var root = $.from_html(`<h1> <p> </p> <p>h1 forth child p text</p></h1> <button> </button> <!>`, 1);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"export default function App($$anchor) {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tlet count = $.state(0);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tlet things = $.proxy(["},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 1, name: 'apple' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 2, name: 'banana' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 3, name: 'carrot' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 4, name: 'doughnut' },"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t{ id: 5, name: 'egg' }"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t]);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar fragment = root();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar h1 = $.first_child(fragment);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar text = $.child(h1);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar p = $.sibling(text);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\tvar text_1 = $.child(p);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t$.reset(p);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar text_2 = $.sibling(p);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t$.next();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t$.reset(h1);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar button = $.sibling(h1, 2);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tbutton.__click = () => $.set(count, $.get(count) + 1);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar text_3 = $.child(button);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t$.reset(button);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\tvar node = $.sibling(button, 2);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t$.each(node, 17, () => things, (thing) => thing.id, ($$anchor, thing) => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar li = root_1();"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\tvar text_4 = $.child(li);"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t\t$.reset(li);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t$.template_effect(() => $.set_text(text_4, `${$.get(thing).id ?? ''} x ${$.get(thing).name ?? ''}`));"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t$.append($$anchor, li);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t});"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t$.template_effect(() => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t$.set_text(text, `h1 first child text ${$.get(count) ?? ''}! `);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t$.set_text(text_1, `h1 second child p text ${$.get(count) ?? ''}`);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t$.set_text(text_2, ` h1 third child text ${$.get(count) ?? ''} `);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t\t$.set_text(text_3, `clicks: ${$.get(count) ?? ''}`);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t});"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"\t$.append($$anchor, fragment);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"}"},{"attributes":{"code-block":"javascript"},"insert":"\n\n"},{"insert":"$.delegate(['click']);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"这是一个完整的编译后的代码。\n这个编译后的代码我们也可以将其分为三个重要的部分：\n\n第一部分是将我们.svelte文件中的script部分作静态替换，将里面的所有调用替换成“"},{"attributes":{"bold":true},"insert":"$"},{"insert":"”提供的api，注意编译后在文件顶部增加了它的引入。\n\n第二部分是构建.svelte文件中的html模板内容，这部分是一个精彩的内容，后面我们来慢慢分析。\n\n第三部分就是设置响应式变量，将html模板模板中所有访问响应式变量的地方全部替换成动态api的访问。你可以看见它是使用"},{"attributes":{"bold":true},"insert":"$.template_effect"},{"insert":"包裹的"},{"attributes":{"bold":true},"insert":"$.set_text"},{"insert":"来完成的。\n\n由于第一部分很操作简单直接，咱们着重分析第二、三部分。\n\n如何构建html模板内容"},{"attributes":{"header":2},"insert":"\n"},{"insert":"首先我们要先理清我们的html模板怎样一个结构，你可能觉得看起来十分简单不就是html模板么，不要着急，我们一步步往下走。\n\n它有三个顶层的兄弟节点h1、button、“list”列表（之后我们暂且用<!>符号来占位替代这个列表）:\n此时的结构可简单归纳为："},{"insert":{"blue700-tag":{"id":1765622130887,"text":"h1 button <!>","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"\n\n然后h1内有四个子节点，文本节点0、p、文本节点2、p:\n此时的结构可简单归纳为："},{"attributes":{"bold":true},"insert":"<h1> 文本节点0 p 文本节点2 p </h1> button <!>"},{"insert":"\n"},{"insert":{"listItemContainer":true}},{"insert":"\n每个p节点内又有自己的文本节点，此时的结构可简单归纳为：\n"},{"attributes":{"bold":true},"insert":"<h1> 文本节点0 <p>文本节点1</p> 文本节点2<p>静态文本节点</p> </h1> button <!>"},{"insert":"\n\nbutton内也有自己的文本节点，此时的结构可简单归纳为：\n"},{"attributes":{"bold":true},"insert":"<h1>文本节点0<p>文本节点1</p>文本节点2<p>静态文本节点</p> </h1> <button>文本节点3</button> <!>"},{"insert":"\n\n此时，我们直接提取静态的部分，也就是：\n"},{"attributes":{"bold":true},"insert":"<h1>  <p> </p> <p>h1 forth child p text</p> </h1> <button> </button> <!>"},{"insert":"\n\n此时，我们就得到了一个我们的html模板中，对应的html完整框架，剩余的内容只剩访问了变量（包括普通变量和响应式变量）的文本节点，只需要在之后处理就行。\n"},{"insert":{"listItemContainer":true}},{"insert":{"listItemContainer":true}},{"insert":"\n"},{"insert":{"listItemContainer":true}},{"insert":"如果我们将这个html框架的字符串，通过浏览器的“template”节点生成Dom，那么我们就得到了这个html框架的Dom实例，而且此时我们只是得到了Dom实例而没有立即渲染，因为接下来我们先要将之前忽略掉的文本节点，也就是哪些访问了变量的文本节点添加上去。\n\n这就是编译后的代码中：\n"},{"attributes":{"bold":true},"insert":"var root = $.from_html(`<h1> <p> </p> <p>h1 forth child p text</p></h1> <button> </button> <!>`, 1);"},{"insert":"\n\n所做的事情，它利用浏览器的“"},{"attributes":{"bold":true},"insert":"template"},{"insert":"”节点为我们静态的html框架生成Dom实例，调用root()会通过“"},{"attributes":{"bold":true},"insert":"template"},{"insert":"”节点的 "},{"insert":{"blue700-tag":{"id":1765622468583,"text":".content.cloneNode(true)","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"  拷贝一个当前模板的Dom实例，然后直接返回实例根节点，之后我们之后再通过这个根节点实例将动态的内容补充上去。\n\n我们先通过字符串和“"},{"attributes":{"bold":true},"insert":"template"},{"insert":"”节点一次性构建一个完整的html框架，使用"},{"attributes":{"bold":true},"insert":"cloneNode"},{"insert":"高效获取模板副本，然后逐步向框架中填充内容，这是一个性能优化的手段，因为被我们不需要构建虚拟Dom，也不需要使用js的api一个一个的创建和添加html内容。\n\n"},{"insert":{"listItemContainer":true}},{"insert":"设置响应式变量-填充文本节点内容"},{"attributes":{"header":2},"insert":"\n"},{"insert":"我们直接看工作代码：\n$.template_effect(() => {"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"    $.set_text(text, `h1 first child text ${$.get(count) ?? ''}! `);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t$.set_text(text_1, `h1 second child p text ${$.get(count) ?? ''}`);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t$.set_text(text_2, ` h1 third child text ${$.get(count) ?? ''} `);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"\t$.set_text(text_3, `clicks: ${$.get(count) ?? ''}`);"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"});"},{"attributes":{"code-block":"javascript"},"insert":"\n"},{"insert":"首先每个文本中，对响应式变量的访问，都会用"},{"attributes":{"bold":true},"insert":"$.get"},{"insert":"这个API替换，然后使用"},{"attributes":{"bold":true},"insert":"$.set_text"},{"insert":"设置每个节点对应的文本内容。\n\n这里的重点，是使用了"},{"attributes":{"bold":true},"insert":" $.template_effect"},{"insert":" 注册一个函数来包裹了所有的操作，换个说法就是：将所有填充文本节点的操作统一放在一个任务中。这个函数调用的时候会加入一个上下文栈，在执行过程中函数内访问了响应式变量，也就是“"},{"attributes":{"bold":true},"insert":"$.get(count)"},{"insert":"”这种，会触发访问拦截，通过访问当前的上下文栈，建立一个响应式变量和当前正在执行的这个注册函数，之前的双向依赖订阅关系\n\n当"},{"attributes":{"bold":true},"insert":"$.template_effec"},{"insert":"执行完毕后，就完成了两件重要的事情：\n填充每个文本节点对应的内容；\n\n为每个文本节点访问的"},{"attributes":{"bold":true},"insert":"响应式变量"},{"insert":"，建立与填充文本节点任务的，双向依赖订阅关系。当任何一个"},{"attributes":{"bold":true},"insert":"响应式变量"},{"insert":"更新都会触发这个任务重新执行，当这个任务重新执行，对应的"},{"attributes":{"bold":true},"insert":"$.set_text"},{"insert":"就会将最新的值填充进对应的文本节点。这就完成了哪个依赖变化，依赖对应部分就更新的精准操作。\n\n如果你还不清楚什么是响应式变量的双向依赖订阅关系，那你可以看看"},{"attributes":{"link":"https://blog.hiou.top/dollar-effect"},"insert":"我之前的文章"},{"insert":"。\n\n"},{"insert":{"listItemContainer":true}},{"insert":"至此，我们已经先后完成了初始化script、构建html模版框架、填充框架内容三件最重要的个事。我们的组件已经准备就绪，现在只需要将html模版框架的根节点加入页面："},{"insert":{"blue700-tag":{"id":1765620932901,"text":"$.append($$anchor, fragment)","renderAsBlock":false,"className":"blue700-tag"}}},{"insert":"，就完成了组件的挂载。\n\n最后"},{"attributes":{"header":2},"insert":"\n"},{"insert":"等等，这就结束了？你会发现我们是不是忘记了什么？好像忘记了我们模板中的列表？没错，列表渲染在编译时被静态替换为$.each来完成，列表渲染涉及到性能和列表增删改的复杂操作，它是每个前端库都十分重要的部分，这正是我们下一篇文章将要深入探究的内容。\n\n"},{"insert":{"listItemContainer":true}},{"insert":{"listItemContainer":true}},{"insert":{"listItemContainer":true}},{"insert":{"listItemContainer":true}}]}

const safeHtml = getSafeHtmlFromDelta(TestDeltaString)

const result = {
    content: safeHtml,
}

export default result;
